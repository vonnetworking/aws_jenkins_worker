---
# tasks file for jenkins_worker

- debug:
    msg: "Executing Role {{ role_name }}"

- name: "install desired python packages"
  pip:
    name:
      - awscli
      - flask
      - pytest
      - snakeviz
      - virtualenv
      - cfn-lint

- name: "override package manager due to bug in ansible 2.8"
  set_fact:
    ansible_facts:
      pkg_mgr: yum

- name: "Install yum packages"
  yum:
    name:
      - nodejs
      - npm
      - java-1.8.0
      - python36
      - zlib-devel
      - gcc
      - gcc-c++
      - ruby-devel
      
- name: "Update ruby mapping to proper version (2.4)"
  command: "sudo alternatives --set ruby /usr/bin/ruby2.4"

- name: "Remove Java 1.7"
  yum:
    name:
      - java-1.7.0-openjdk
      - java-1.7.0
    state: removed

- name: "Create Jenkins user"
  user:
    name: jenkins
    comment: "Jenkins slave user"
    home: /home/jenkins
    shell: /bin/bash

- name: "Create /opt/jenkins directory"
  file:
    path: /opt/jenkins
    state: directory
    owner: jenkins
    group: ec2-user
    mode: '0775'

- name: "Configure default AWS region (us-east-1)"
  command: "aws configure set region us-east-1"
  become: yes
  become_user: root

- name: "Link AWS exec into /usr/local/bin"
  file:
    src: '/usr/bin/aws'
    dest: '/usr/local/bin/aws'
    state: link

- name: "Link node exec into /usr/local/bin"
  file:
    src: '/usr/bin/node'
    dest: '/usr/local/bin/node'
    state: link

- name: "Link npm exec into /usr/local/bin"
  file:
    src: '/usr/bin/npm'
    dest: '/usr/local/bin/npm'
    state: link

- name: "Grab pipeline scripts to /opt/jenkins/scripts directory"
  git:
    repo: '{{ pipeline_script_repo }}'
    dest: /opt/jenkins/scripts

- name: "Update permissions on all pipeline scripts"
  file:
    path: /opt/jenkins/scripts
    state: directory
    mode: 0744
    owner: jenkins
    group: ec2-user
